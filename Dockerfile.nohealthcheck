# DOCKERFILE WITHOUT HEALTH CHECK - FOR EASYPANEL
# This version removes health check to prevent restart loops

FROM node:22-alpine

# Install basic tools
RUN apk add --no-cache curl bash

# Set working directory
WORKDIR /app

# Copy package files
COPY package.json pnpm-lock.yaml* ./

# Install pnpm and dependencies
RUN npm install -g pnpm@10.14.0 && \
    pnpm install --frozen-lockfile

# Copy source code
COPY . .

# Build the server
RUN pnpm run build:server

# Verify build
RUN ls -la dist/server/production.mjs || (echo "❌ Build failed" && exit 1)

# Create simple startup script
RUN echo '#!/bin/bash' > /app/start.sh && \
    echo 'echo "🚀 EASYPANEL START - No Health Check Version"' >> /app/start.sh && \
    echo 'echo "NODE_ENV: $NODE_ENV"' >> /app/start.sh && \
    echo 'echo "PORT: $PORT"' >> /app/start.sh && \
    echo 'echo "DB_HOST: $DB_HOST"' >> /app/start.sh && \
    echo 'echo "🔥 Starting server..."' >> /app/start.sh && \
    echo 'exec node dist/server/production.mjs' >> /app/start.sh && \
    chmod +x /app/start.sh

# Expose port
EXPOSE 80

# NO HEALTH CHECK - Let EasyPanel handle it externally
# This prevents the restart loop

# Environment defaults
ENV NODE_ENV=production
ENV PORT=80

# Start the application
CMD ["/app/start.sh"]
